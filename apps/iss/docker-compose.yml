services:
  # ==========================================================================
  # POSTGRES - REMOVED (Use Central Stack at central-postgres:5432)
  # ==========================================================================

  # ==========================================================================
  # REDIS - REMOVED (Use Central Stack at central-redis:6379)
  # ==========================================================================

  # ISS Backend API - Ottimizzato per produzione
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
      target: production
    container_name: iss-backend
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-central_admin_password_2025}@central-postgres:5432/iss_wbs
      - DATABASE_MAX_OVERFLOW=30

      # Security
      - SECRET_KEY=${SECRET_KEY:-your-super-secret-key-change-in-production-please}
      - ACCESS_TOKEN_EXPIRE_MINUTES=30

      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD:-central_redis_password_2025}@central-redis:6379/3
      - REDIS_CACHE_TTL=3600

      # Environment
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DEBUG=${DEBUG:-false}

      # CORS
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3001,http://localhost:3000,https://iss-aps.it}

      # Email ottimizzato
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM=${MAIL_FROM:-noreply@iss-aps.it}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_SERVER=${MAIL_SERVER:-smtp.gmail.com}
      - MAIL_TLS=${MAIL_TLS:-true}
      - MAIL_SSL=${MAIL_SSL:-false}

      # Upload e storage
      - UPLOAD_DIR=/app/static/uploads
      - MAX_UPLOAD_SIZE=10485760 # 10MB

      # Performance
      - WORKERS=4
      - WORKER_CONNECTIONS=1000

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=json

      # Rate limiting
      - RATE_LIMIT_PER_MINUTE=60

      # AI Services - API Keys per ricerca bandi
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - AI_SEARCH_ENABLED=${AI_SEARCH_ENABLED:-true}

      # Ollama (Primary LLM)
      - OLLAMA_HOST=central-ollama
      - OLLAMA_PORT=11434
      - OLLAMA_MODEL=llama3.2:3b
      - USE_OLLAMA=true
      - LLM_PROVIDER=ollama

    volumes:
      - backend_uploads:/app/static/uploads
      - backend_logs:/app/logs
      - ./config/backend:/app/config:ro
    # ports:
    #   - "${BACKEND_PORT:-8001}:8000" # Exposed via Gateway
    networks:
      - iss-network
      - web_gateway
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    #   redis:
    #     condition: service_healthy

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
      # PgAdmin for database management (disabled - causing restart issues)
      # pgadmin:
      #   image: dpage/pgadmin4:latest
      #   container_name: iss-pgadmin
      #   environment:
      #     PGADMIN_DEFAULT_EMAIL: admin@iss.local
      #     PGADMIN_DEFAULT_PASSWORD: admin123
      #     PGADMIN_CONFIG_SERVER_MODE: 'False'
      #   volumes:
      #     - pgadmin_data:/var/lib/pgadmin
      #   ports:
      #     - "5050:80"
      #   networks:
      #     - iss-network
      #   depends_on:
      #     - postgres


      # ISS Frontend - React + Nginx ottimizzato
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      target: production
    container_name: iss-frontend
    restart: unless-stopped
    environment:
      - VITE_API_BASE_URL=${FRONTEND_API_URL:-/api}
      - VITE_ENVIRONMENT=${ENVIRONMENT:-production}
      - VITE_APP_NAME=ISS - Innovazione Sociale Salernitana
      - VITE_APP_VERSION=2.0.0
    # ports:
    #   - "${FRONTEND_PORT:-3001}:3000" # Exposed via Gateway
    networks:
      - iss-network
      - web_gateway
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000/index.html" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
  # Nginx Reverse Proxy - REMOVED (Use Central Gateway)
  # nginx-proxy:


volumes:
  # NOTE: postgres_data and redis_data REMOVED - using central stack

  # Upload files backend
  backend_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./data}/uploads

  # Logs backend
  backend_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./data}/logs

  # Logs nginx proxy
  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./data}/nginx-logs

  # Certbot webroot
  certbot_webroot:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-./data}/certbot-webroot

networks:
  iss-network:
    driver: bridge
    name: iss-network

  web_gateway:
    external: true
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: iss-bridge
      com.docker.network.driver.mtu: 1500
