name: ironrep-prod

services:
  # ================================
  # Backend - FastAPI Production
  # ================================
  backend:
    build:
      context: ../../apps/backend
      dockerfile: ../../config/docker/dockerfiles/backend.Dockerfile
    image: ironrep-backend:${VERSION:-latest}
    container_name: ironrep-backend-prod
    # ports:
    #   - "8000:8000" # Exposed via Gateway
    volumes:
      # Persist ChromaDB embeddings
      - chroma_data:/app/chroma_db
    env_file:
      - .env.prod
    environment:
      - PYTHONUNBUFFERED=1
      # Override database URL for container networking
      - DATABASE_URL=postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-central_admin_password_2025}@central-postgres:5432/ironrep
      # ChromaDB server connection (container name)
      - CHROMA_HOST=central-chromadb
      - CHROMA_PORT=8000
      # Redis (container name)
      - REDIS_URL=redis://:${REDIS_PASSWORD:-central_redis_password_2025}@central-redis:6379/4
      # Ollama LLM (PRIMARY)
      - USE_OLLAMA=true
      - OLLAMA_HOST=central-ollama
      - OLLAMA_PORT=11434
      - OLLAMA_MODEL=qwen2.5-coder:7b-instruct
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    #   redis:
    #     condition: service_healthy
    #   chromadb:
    #     condition: service_healthy
    restart: always
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ironrep-network
      - web_gateway
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 1G

  # ================================
  # Frontend - Nginx Production
  # ================================
  frontend:
    build:
      context: ../../apps/frontend
      dockerfile: ../../config/docker/dockerfiles/frontend.Dockerfile
      args:
        - VITE_API_URL=
        - VITE_API_BASE_URL=http://backend:8000
        - NODE_ENV=production
    image: ironrep-frontend:${VERSION:-latest}
    container_name: ironrep-frontend-prod
    # ports:
    #   - "80:80"
    #   - "443:443"
    environment:
      - VITE_API_URL=/api
      - NODE_ENV=production
      # PWA environment (built into static files)
    volumes:
      # - /etc/letsencrypt:/etc/letsencrypt:ro # Global Gateway handles SSL
      - ../../config/services/nginx/nginx-internal.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    restart: always
    healthcheck:
      test: [ "CMD", "nginx", "-t" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ironrep-network
      - web_gateway
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
  # ==========================================================================
  # REDIS - REMOVED (Use Central Stack)
  # ==========================================================================

  # ==========================================================================
  # CHROMADB - REMOVED (Use Central Stack)
  # ==========================================================================

  # ==========================================================================
  # POSTGRES - REMOVED (Use Central Stack)
  # ==========================================================================

  # ==========================================================================
  # PGADMIN - REMOVED (Use Central Stack / Optional)
  # ==========================================================================

  # ================================
  # Volumes
  # ================================
volumes:
  chroma_data:
    driver: local

# ================================
# Networks
# ================================
networks:
  ironrep-network:
    driver: bridge

  web_gateway:
    external: true
